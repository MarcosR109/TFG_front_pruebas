<div class="grid-container">
  <div class="scroll-container">
    <div
      *ngFor="let linea of lines; let index = index"
      class="input-group"
      [style.width]="maxWidth"
    >
      <div class="square-container" [style.width]="maxWidth">
        <mat-card
          class="square"
          *ngFor="
            let acorde of linea.acordes;
            let squareIndex = index;
            trackBy: trackByAcorde
          "
          (touchend)="pegarAcorde()"
        >
          <!-- Botón "x" para limpiar el contenido textual (solo visible si hay contenido) -->
          <button
            *ngIf="acorde.acorde && !block"
            class="delete-button"
            (click)="eliminarAcorde($event, linea.n_linea, squareIndex)"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              height="15px"
              viewBox="0 -960 960 960"
              width="15px"
              fill="#999999"
            >
              <path
                d="m291-240-51-51 189-189-189-189 51-51 189 189 189-189 51 51-189 189 189 189-51 51-189-189-189 189Z"
              />
            </svg>
          </button>
          <!-- Contenido del acorde -->
          <div
            class="square-content"
            [attr.data-linea]="linea.n_linea"
            [attr.data-index]="squareIndex"
          >
            <app-acordeshow
              *ngIf="acorde.acorde != 'aux'"
              [chord]="acorde.acorde || ''"
              [variacion]="acorde.variacion || ''"
              [semitones]="this.semitones"
            ></app-acordeshow>
          </div>
        </mat-card>
      </div>
      <!-- Campo de entrada de texto -->
      <mat-form-field
        *ngIf="!block"
        appearance="outline"
        class="input-field"
        [style.width]="maxWidth"
      >
        <input
          matInput
          [(ngModel)]="linea.texto"
          placeholder="Texto recibido"
        />
      </mat-form-field>

      <!-- Texto plano cuando this.block es true -->
      <div *ngIf="block" class="plaintext">
        <p class="text-material-design">
          {{ linea.texto }}
        </p>
      </div>

      <div class="button-container" *ngIf="!block">
        <button
          mat-raised-button
          class="add-line-btn"
          color="secondary"
          (click)="agregarLineaDebajo(index)"
        >
          +
        </button>
        <button
          mat-raised-button
          color="secondary"
          class="delete-line-btn"
          (click)="eliminarLinea(index)"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="20px"
            viewBox="0 0 24 24"
            width="20px"
            fill="#000000"
          >
            <path d="M0 0h24v24H0V0z" fill="none" />
            <path
              d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"
            />
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Panel flotante inferior para herramientas/acordes -->
<div class="mobile-tools-panel" [class.open]="panelAbierto">
  <div class="panel-header" (click)="togglePanel()">
    <mat-icon>{{ panelAbierto ? "expand_more" : "expand_less" }}</mat-icon>
    <span>Herramientas</span>
    <div class="header-actions">
      <button
        class="tool-btn"
        (click)="$event.stopPropagation(); toggleNotation()"
      >
        {{ notation === "latin" ? "SP" : "LT" }}
      </button>
      <button
        class="tool-btn"
        (click)="$event.stopPropagation(); togglePreferirSostenidos()"
      >
        {{ preferirSostenidos ? "♯" : "♭" }}
      </button>
    </div>
  </div>

  <div class="panel-content" *ngIf="panelAbierto">
    <!-- Acordes por tonalidad -->
    <div class="acordes-section">
      <h3 class="section-title">Acordes por tonalidad</h3>
      <div class="tonalidades-scroll">
        <div class="scroll-content">
          <button
            *ngFor="let tonalidad of tonalidades"
            (click)="toggleTonalidad(tonalidad)"
            class="tonalidad-box"
            [class.seleccionada]="tonalidadExpandida === tonalidad"
          >
            {{ tonalidad }}
          </button>
        </div>
      </div>

      <div class="acordes-container" *ngIf="tonalidadExpandida">
        <div
          *ngFor="let acorde of getAcordesDeTonalidad(tonalidadExpandida)"
          class="acorde-box"
          (touchstart)="onTouch($event, acorde)"
        >
          {{ acorde.acorde }}
        </div>
      </div>
    </div>

    <!-- Variaciones -->
    <div class="variaciones-section">
      <h3 class="section-title">Variaciones</h3>
      <div class="variaciones-slider">
        <button
          *ngFor="let variacion of variaciones"
          class="variacion-btn"
          (touchstart)="onTouchVariacion($event, variacion)"
        >
          {{ variacion }}
        </button>
      </div>
    </div>
    <!-- Sección de velocidad y scroll automático -->
    <!-- Panel de recomendaciones -->
    <div class="recomendaciones-section">
      <h3 class="section-title">Recomendados</h3>
      <div class="recomendaciones-container" *ngIf="!loading">
        <div
          *ngFor="let acorde of acordesRecomendados"
          class="acorde-recomendado"
          (touchstart)="$event.stopPropagation(); onTouch($event, acorde)"
          [ngClass]="acorde.probabilidad >= 0.5 ? 'probable' : 'poco-probable'"
        >
          <app-acordeshow
            [chord]="acorde.acorde || ''"
            [variacion]="acorde.variacion || ''"
            [semitones]="this.semitones"
          ></app-acordeshow>
        </div>
      </div>
      <mat-progress-spinner
        mode="indeterminate"
        diameter="40"
        *ngIf="loading"
      ></mat-progress-spinner>
    </div>
    <div class="tools-row">
      <button class="control-btn" (click)="substractVelocidad()">
        <mat-icon>remove</mat-icon>
      </button>
      <button
        class="control-btn play-btn"
        *ngIf="!this.scrollId"
        (click)="startAutoScroll()"
      >
        <mat-icon>play_arrow</mat-icon>
      </button>
      <button
        class="control-btn stop-btn"
        *ngIf="this.scrollId"
        (click)="resetAutoScroll()"
      >
        <mat-icon>stop</mat-icon>
      </button>
      <button class="control-btn" (click)="addVelocidad()">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <!-- Sección de transposición -->
    <div class="tools-row">
      <button class="transpose-btn" (click)="modSemitono(-1)">
        <span>-1</span>
      </button>
      <button
        class="transpose-btn reset-btn"
        (click)="modSemitono(-this.semitones)"
      >
        <mat-icon>undo</mat-icon>
      </button>
      <button class="transpose-btn" (click)="modSemitono(+1)">
        <span>+1</span>
      </button>
    </div>
  </div>
</div>
